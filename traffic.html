<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Traffic Management UI â€” Demo</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --muted:#6b7280; --accent:#4f46e5;
      --success:#10b981; --danger:#ef4444; --warn:#f59e0b;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    .container{max-width:1200px;margin:20px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .top-actions{display:flex;gap:8px;align-items:center}
    button{cursor:pointer;border:0;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff}
    .secondary{background:#fff;color:#111;border:1px solid #e5e7eb}
    .grid{display:grid;gap:12px}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    /* Live monitoring */
    .monitor-wrap{display:flex;gap:12px}
    .streams{width:220px}
    .stream-btn{display:flex;flex-direction:column;align-items:flex-start;gap:6px;padding:8px;border-radius:8px;border:1px solid transparent;background:#f8fafc}
    .stream-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,70,229,0.06)}
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .video-area{flex:1;position:relative;border-radius:10px;overflow:hidden;background:#111;height:320px;display:flex;align-items:center;justify-content:center;color:#fff}
    .video-area video, .video-area .placeholder{width:100%;height:100%;object-fit:cover}
    .overlay-canvas{position:absolute;left:0;top:0;pointer-events:none}
    .badge{background:rgba(0,0,0,0.45);padding:6px 8px;border-radius:8px;color:#fff;font-size:13px}
    /* Signal list */
    .sig-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #eef2ff}
    .sig-left{display:flex;gap:8px;align-items:center}
    .circle{width:12px;height:12px;border-radius:50%}
    .controls{display:flex;gap:8px}
    /* Heatmap */
    .heat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .heat-item{padding:12px;border-radius:8px;color:#fff}
    .green{background:#10b981}
    .yellow{background:#f59e0b}
    .red{background:#ef4444}
    /* analytics */
    .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .stat{padding:12px;border-radius:8px;border:1px solid #eef2ff;text-align:center}
    /* Predictions */
    .pred-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #fde68a;background:linear-gradient(90deg,#fff7ed, #fff)}
    /* Reports */
    .report-list{display:flex;flex-direction:column;gap:8px}
    /* responsive */
    @media (max-width:900px){
      .monitor-wrap{flex-direction:column}
      .streams{width:100%;display:flex;overflow:auto}
      .video-area{height:220px}
      .grid.cols-3{grid-template-columns:1fr}
      .grid.cols-2{grid-template-columns:1fr}
    }
    small{color:var(--muted)}

    .video-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;  /* 2 videos per row */
      grid-template-rows: 1fr 1fr;     /* 2 rows */
      gap: 10px;
      width: 100%;
      height: 500px;
    }
    .video-box {
      position: relative;
      background: black;
      border-radius: 8px;
      overflow: hidden;
    }
    .video-box video {
      width: 200%;
      height: 100%;
      object-fit: cover;
    }
    .live-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      padding: 4px 8px;
      border-radius: 6px;
      color: white;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }
    .live-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: red;
      margin-right: 6px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Traffic Management Dashboard</h1>
      <div class="top-actions">
        <div class="badge">Operator: City Traffic</div>
        <button id="exportBtn" class="secondary">Export Congestion CSV</button>
      </div>
    </header>

    <main class="grid">
      <!-- Live + Signals top row -->
      <div class="grid cols-1">
        <!-- LIVE MONITORING -->
        <section class="card">
          <h2 style="margin:0 0 8px 0">Live Monitoring</h2>
          <div class="monitor-wrap">
            <div class="streams">
              <!-- buttons filled by JS -->
              <div id="streamsContainer"></div>
            </div>

           <!--<div class="video-area" id="videoArea">-->
                    <!-- Video Player -->
                    <!-- <video id="trafficVideo" width="100%" height="100%" autoplay loop muted controls> 
                        <source src="video4.mp4" type="video/mp4">    
                        Your browser does not support the video tag.            
                    </video> -->

                 <div class="video-grid" id="videoArea">
                <div class="video-box">
                  <video autoplay muted loop controls>
                    <source src="video4.mp4" type="video/mp4">
                    Your browser does not support video.
                  </video>
                  <div class="live-badge"><span class="dot"></span> LIVE</div>
                </div>

                <div class="video-box">
                  <video autoplay muted loop controls>
                    <source src="video4.mp4" type="video/mp4">
                    Your browser does not support video.
                  </video>
                  <div class="live-badge"><span class="dot"></span> LIVE</div>
                </div>

                <div class="video-box">
                  <video autoplay muted loop controls>
                    <source src="video4.mp4" type="video/mp4">
                    Your browser does not support video.
                  </video>
                  <div class="live-badge"><span class="dot"></span> LIVE</div>
                </div>

                <div class="video-box">
                  <video autoplay muted loop controls>
                    <source src="video4.mp4" type="video/mp4">
                    Your browser does not support video.
                  </video>
                  <div class="live-badge"><span class="dot"></span> LIVE</div>
                </div>
              </div>



              <!-- overlay canvas -->
              <!-- <canvas id="overlay" class="overlay-canvas"></canvas> -->

              <!-- overlay badges -->
               <!--<div </div> style="position:absolute;left:12px;top:12px" class="badge">LiveðŸ”´ <span id="currentStream"></span></div> -->
               

              <!-- <div style="position:absolute;right:12px;bottom:12px" class="badge" id="detectionSummary">Detections â€” Car 0 â€¢ Bike 0</div> -->
            </div>
          </div>
        </section>

        <!-- SIGNAL STATUS -->
        <aside class="card">
          <h2 style="margin:0 0 8px 0">Traffic Signal Status</h2>
          <div id="signalsList" style="display:flex;flex-direction:column;gap:8px"></div>

          <div style="margin-top:12px">
            <h3 style="margin:0 0 6px 0">Quick Controls</h3>
            <div style="display:flex;gap:8px">
              <button id="setAllAIBtn" class="secondary">Set All AI Mode</button>
              <button id="pauseAIBtn" class="secondary">Pause AI</button>
              <button id="emergencyBtn" style="background:var(--danger)">Emergency Mode</button>
            </div>
            <small>Manual overrides send commands to the backend. (See comments in code.)</small>
          </div>
        </aside>
      </div>

      <!-- Heatmap + Analytics -->
      <div class="grid cols-2">
        <section class="card">
          <h2 style="margin:0 0 8px 0">Congestion Heatmap</h2>
          <div id="heatmap" class="heat-grid"></div>
          <small style="display:block;margin-top:8px">Map is a mock grid. Replace with Leaflet/Mapbox + geo data for real deployment.</small>
        </section>

        <section class="card">
          <h2 style="margin:0 0 8px 0">Analytics Dashboard</h2>
          <div class="stat-grid" id="analyticsStats">
            <div class="stat"><small>Avg Wait (s)</small><div id="avgWait" style="font-size:20px;font-weight:700">0</div></div>
            <div class="stat"><small>Vehicles Passed</small><div id="vehiclesPassed" style="font-size:20px;font-weight:700">0</div></div>
            <div class="stat"><small>% Commute â†“</small><div id="commuteDrop" style="font-size:20px;font-weight:700">0%</div></div>
          </div>

          <div style="margin-top:12px">
            <h4 style="margin:8px 0 6px 0">Historical (7 days)</h4>
            <!-- simple inline svg chart -->
            <svg id="lineChart" viewBox="0 0 200 60" style="width:100%;height:64px;border-radius:8px;border:1px solid #eef2ff;background:#fff">
              <polyline fill="none" stroke="#4f46e5" stroke-width="2" points="" id="trendLine"></polyline>
            </svg>
          </div>
        </section>
      </div>

      <!-- Predictions + Reports -->
      <div class="grid cols-3">
        <section class="card" style="grid-column:span 2">
          <h2 style="margin:0 0 8px 0">Predictions & Alerts</h2>
          <div id="predictions"></div>
          <small style="display:block;margin-top:8px">Predictions are mock; connect ML / /predict endpoint to populate from a model.</small>
        </section>

        <section class="card">
          <h2 style="margin:0 0 8px 0">Reports & Insights</h2>
          <div class="report-list">
            <div style="padding:8px;border-radius:8px;border:1px solid #eef2ff">
              <small>Peak Hours</small>
              <div style="font-weight:600">08:00 - 10:00, 17:00 - 19:00</div>
            </div>

            <div style="padding:8px;border-radius:8px;border:1px solid #eef2ff">
              <small>Long-term Suggestion</small>
              <div style="font-weight:600">Consider flyover at Junction 3</div>
            </div>

            <div style="padding:8px;border-radius:8px;border:1px solid #eef2ff">
              <button id="downloadMonthly" style="width:100%;padding:8px;border-radius:8px;background:var(--accent);color:#fff">Download Monthly Report</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer style="margin-top:14px;color:var(--muted)"><small>Tip: Replace mocks with live streams, detection endpoints, and signal control APIs for production.</small></footer>
  </div>

<script>
/* -------------------------
   Mock data & initial state
   ------------------------- */
const streams = [
  { id: 'cam-1', name: 'Junction 1', status: 'connected', src: '' },
  { id: 'cam-2', name: 'Highway 3', status: 'connected', src: '' },
  { id: 'cam-3', name: 'Junction 2', status: 'disconnected', src: '' }
];

let signals = [
  { id: 's-1', name: 'Junction 1 - N/S', mode: 'AI', color: 'green', remaining: 22 },
  { id: 's-2', name: 'Junction 1 - E/W', mode: 'Manual', color: 'red', remaining: 45 },
  { id: 's-3', name: 'Highway 3 - N/S', mode: 'AI', color: 'green', remaining: 12 }
];

let congestion = [
  { id: 'j-1', name: 'Junction 1', level: 0.75 },
  { id: 'j-2', name: 'Junction 2', level: 0.25 },
  { id: 'j-3', name: 'Highway 3', level: 0.92 }
];

let analytics = { avgWait: 34, vehiclesPassed: 12345, commuteReduction: 12 };

let predictions = [
  { id:'p-1', area:'Junction 1', etaMins:10, severity:'High' },
  { id:'p-2', area:'Highway 3', etaMins:6, severity:'Critical' }
];

let selectedStream = null;

/* -------------------------
   DOM helpers & rendering
   ------------------------- */

const streamsContainer = document.getElementById('streamsContainer');
const signalsList = document.getElementById('signalsList');
const heatmapEl = document.getElementById('heatmap');
const avgWaitEl = document.getElementById('avgWait');
const vehiclesPassedEl = document.getElementById('vehiclesPassed');
const commuteDropEl = document.getElementById('commuteDrop');
const predictionsEl = document.getElementById('predictions');
const currentStreamEl = document.getElementById('currentStream');
const detectionSummaryEl = document.getElementById('detectionSummary');
const overlay = document.getElementById('overlay');
const videoArea = document.getElementById('videoArea');
const videoPlaceholder = document.getElementById('videoPlaceholder');
const exportBtn = document.getElementById('exportBtn');
const trendLine = document.getElementById('trendLine');
const downloadMonthly = document.getElementById('downloadMonthly');

/* render available streams */
function renderStreams(){
  streamsContainer.innerHTML = '';
  streams.forEach(s => {
    const btn = document.createElement('div');
    btn.className = 'stream-btn' + (selectedStream === s.id ? ' active' : '');
    btn.tabIndex = 0;
    btn.onclick = ()=>selectStream(s.id);
    const statusDot = `<span class="status-dot" style="background:${s.status==='connected'?'var(--success)':'#ef4444'}"></span>`;
    btn.innerHTML = `<div style="font-weight:600">${s.name}</div><div style="font-size:12px;color:var(--muted)">${statusDot}${s.status}</div>`;
    streamsContainer.appendChild(btn);
  });
}

/* select a stream (placeholder behavior) */
function selectStream(id){
  selectedStream = id;
  currentStreamEl.textContent = id;
  videoPlaceholder.style.display = 'flex';
  // TODO: Replace placeholder with real video player (HLS.js / video.js / flv.js / RTSP->HLS proxy)
  // Example: mount hls.js stream into a <video> element here.
  renderStreams();
}

/* render signals */
function renderSignals(){
  signalsList.innerHTML = '';
  signals.forEach(sig => {
    const row = document.createElement('div');
    row.className = 'sig-row';
    row.innerHTML = `
      <div class="sig-left">
        <div class="circle" style="background:${sig.color === 'green' ? '#10b981' : sig.color==='red' ? '#ef4444' : '#f59e0b'}"></div>
        <div>
          <div style="font-weight:600">${sig.name}</div>
          <div style="font-size:12px;color:var(--muted)">Mode: ${sig.mode}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="font-size:13px;color:var(--muted)">${sig.remaining}s</div>
        <div class="controls">
          <button class="secondary" data-id="${sig.id}" data-action="toggle">Toggle</button>
          <button class="secondary" data-id="${sig.id}" data-action="override">Override</button>
        </div>
      </div>
    `;
    signalsList.appendChild(row);
  });
}

/* render heatmap */
function renderHeatmap(){
  heatmapEl.innerHTML = '';
  congestion.forEach(c => {
    const div = document.createElement('div');
    const colorClass = c.level >= 0.75 ? 'red' : c.level >= 0.4 ? 'yellow' : 'green';
    div.className = `heat-item ${colorClass}`;
    div.innerHTML = `<div style="font-weight:700">${c.name}</div><div style="font-size:13px">Level: ${(c.level*100).toFixed(0)}%</div>`;
    heatmapEl.appendChild(div);
  });
}

/* render analytics & trend */
function renderAnalytics(){
  avgWaitEl.textContent = analytics.avgWait;
  vehiclesPassedEl.textContent = analytics.vehiclesPassed.toLocaleString();
  commuteDropEl.textContent = analytics.commuteReduction + '%';

  // mock 7-day trend points -> map to svg polyline
  const points = [45,38,40,30,37,33,34];
  const width = 200, height = 60;
  const step = width / (points.length - 1);
  const max = Math.max(...points), min = Math.min(...points);
  const normalize = v => {
    if (max === min) return height/2;
    return height - ((v - min) / (max - min) * (height - 8)) - 4;
  };
  const poly = points.map((p,i)=>`${i*step},${normalize(p)}`).join(' ');
  trendLine.setAttribute('points', poly);
}

/* render predictions */
function renderPredictions(){
  predictionsEl.innerHTML = '';
  predictions.forEach(p=>{
    const d = document.createElement('div');
    d.className = 'pred-item';
    d.innerHTML = `<div><div style="font-weight:600">${p.area}</div><div style="font-size:12px;color:var(--muted)">ETA: ${p.etaMins} mins â€” ${p.severity}</div></div>
                   <div><button data-id="${p.id}" class="secondary">Alert</button></div>`;
    predictionsEl.appendChild(d);
  });
}

/* initial render */
renderStreams();
renderSignals();
renderHeatmap();
renderAnalytics();
renderPredictions();

/* -------------------------
   Interactivity & behaviors
   ------------------------- */

/* overlay demo drawing - resize canvas to container */
function fitCanvas(){
  const canvas = overlay;
  const rect = videoArea.getBoundingClientRect();
  canvas.width = Math.floor(rect.width);
  canvas.height = Math.floor(rect.height);
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
}
window.addEventListener('resize', fitCanvas);
fitCanvas();

/* draw fake detection boxes and update detection summary */
function drawOverlay(){
  const ctx = overlay.getContext('2d');
  ctx.clearRect(0,0,overlay.width,overlay.height);

  // random demo boxes
  const boxes = [
    {x: 30, y: 50, w: 120, h:60, label: 'Car', count: Math.floor(Math.random()*8)},
    {x: 200, y: 80, w: 150, h:80, label: 'Truck', count: Math.floor(Math.random()*3)}
  ];
  boxes.forEach((b,i)=>{
    ctx.lineWidth = 2;
    ctx.strokeStyle = i === 0 ? 'rgba(0,255,0,0.9)' : 'rgba(255,165,0,0.9)';
    ctx.strokeRect(b.x, b.y, b.w, b.h);
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(b.x, b.y - 20, 80, 18);
    ctx.fillStyle = '#fff';
    ctx.font = '13px sans-serif';
    ctx.fillText(`${b.label}: ${b.count}`, b.x + 6, b.y - 6);
  });

  // update detection summary text
  detectionSummaryEl.textContent = `Detections â€” Car ${boxes[0].count} â€¢ Bike 2 â€¢ Truck ${boxes[1].count}`;
}

/* run overlay periodically for demo */
setInterval(drawOverlay, 2500);
drawOverlay();

/* handle signal button clicks (delegation) */
signalsList.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const action = btn.getAttribute('data-action');
  if (action === 'toggle'){
    // toggle color between green/red and set manual
    signals = signals.map(s => s.id === id ? {...s, color: s.color === 'green' ? 'red' : 'green', mode: 'Manual', remaining: 60 } : s);
    renderSignals();
    // TODO: POST to backend: /signals/override {id, color, seconds}
    console.log('Toggled', id);
    alert('Signal toggled (demo). In production, this would send a backend command.');
  } else if (action === 'override'){
    // simple prompt demo for manual override
    const newColor = prompt('Set signal color (green / yellow / red):', 'green');
    const seconds = parseInt(prompt('Set duration (seconds):', '60'), 10) || 60;
    if (newColor){
      signals = signals.map(s => s.id === id ? {...s, color: newColor, remaining: seconds, mode: 'Manual'} : s);
      renderSignals();
      // TODO: send POST to backend
      console.log('Override', id, newColor, seconds);
      alert('Manual override requested (demo).');
    }
  }
});

/* quick controls */
document.getElementById('setAllAIBtn').addEventListener('click', ()=>{
  signals = signals.map(s => ({...s, mode:'AI'}));
  renderSignals();
});
document.getElementById('pauseAIBtn').addEventListener('click', ()=>{
  signals = signals.map(s => ({...s, mode:'Manual'}));
  renderSignals();
});
document.getElementById('emergencyBtn').addEventListener('click', ()=>{
  if(!confirm('Activate emergency mode? This will set all signals to red/stop.')) return;
  signals = signals.map(s => ({...s, color:'red', mode:'Manual', remaining:120}));
  renderSignals();
});

/* export CSV for congestion */
exportBtn.addEventListener('click', ()=>{
  const rows = [['Junction','CongestionLevel'], ...congestion.map(c=>[c.name,(c.level).toFixed(2)])];
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'congestion_report.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* monthly report (demo text file) */
downloadMonthly.addEventListener('click', ()=>{
  const text = `Monthly Traffic Report\nPeak Hours: 08:00-10:00, 17:00-19:00\nSuggestion: Flyover at Junction 3\nGenerated: ${new Date().toLocaleString()}`;
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'monthly_report.txt'; a.click();
  URL.revokeObjectURL(url);
});

/* prediction alert buttons (delegation) */
predictionsEl.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  alert('Alert sent to operators (demo). In production, this would trigger push/notification.');
});

/* simulate live updates (mock for demo) */
setInterval(()=>{
  // mutate congestion slightly
  congestion = congestion.map(c => ({...c, level: Math.min(1, Math.max(0, c.level + (Math.random()-0.5)*0.06))}));
  // update analytics randomly
  analytics.avgWait = Math.max(8, Math.round(analytics.avgWait + (Math.random()-0.5)*4));
  analytics.vehiclesPassed += Math.round(Math.random()*20);
  analytics.commuteReduction = Math.max(0, Math.min(50, analytics.commuteReduction + Math.round((Math.random()-0.5)*2)));

  // reduce timers for signals
  signals = signals.map(s => ({...s, remaining: Math.max(0, s.remaining - 3)}));

  renderHeatmap();
  renderAnalytics();
  renderSignals();

}, 3000);

/* accessibility: keyboard stream selection */
streamsContainer.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && e.target) {
    const idx = Array.from(streamsContainer.children).indexOf(e.target);
    if (idx >= 0) selectStream(streams[idx].id);
  }
});

/* initial select first connected stream */
const firstConnected = streams.find(s => s.status === 'connected');
if (firstConnected) selectStream(firstConnected.id);

</script>
</body>
</html>
